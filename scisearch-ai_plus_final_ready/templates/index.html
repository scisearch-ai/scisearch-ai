<script>
  const FILTER_OPTIONS = {
    PubMed: [
      "Randomized Controlled Trial[Publication Type]",
      "Systematic Review[Publication Type]",
      "Meta-Analysis[Publication Type]",
      "Observational Study[Publication Type]",
      "Case Reports[Publication Type]"
    ],
    Scopus: [
      "DOCTYPE(ar)",
      "DOCTYPE(re)",
      "DOCTYPE(cp)",
      "DOCTYPE(ch)",
      "DOCTYPE(ed)"
    ]
  };

  async function analyzeQuestion() {
    const question = document.getElementById("question").value.trim();
    if (!question) {
      alert("Please enter a clinical question.");
      return;
    }
    try {
      const res = await fetch("/analyze", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ question })
      });
      if (!res.ok) {
        const err = await res.json();
        throw new Error(err.error || "Unknown error");
      }
      const data = await res.json();
      // Preenche os campos PICOT
      document.getElementById("population").value   = data.population   || "";
      document.getElementById("intervention").value = data.intervention || "";
      document.getElementById("comparison").value   = data.comparison   || "";
      document.getElementById("outcome").value      = data.outcome      || "";
      document.getElementById("time").value         = data.time         || "";
      // Exibe a seção de filtros
      document.getElementById("picot-section").style.display = "block";
    } catch (e) {
      alert("Error analyzing question: " + e.message);
    }
  }

  function toggleAllDatabases(cb) {
    document
      .querySelectorAll(".database-checkbox")
      .forEach(x => x.checked = cb.checked);
    updateFilters();
  }

  function updateFilters() {
    const selected = Array.from(
      document.querySelectorAll(".database-checkbox:checked")
    ).map(x => x.value);
    const container = document.getElementById("filters-container");
    container.innerHTML = "";
    selected.forEach(base => {
      const opts = FILTER_OPTIONS[base] || [];
      const div = document.createElement("div");
      div.innerHTML = `<strong>${base} Filters:</strong><br>` +
        opts.map(o =>
          `<label><input type="checkbox" name="filter_${base}" value="${o}"> ${o}</label>`
        ).join("<br>");
      container.appendChild(div);
    });
  }

  function startSearch() {
    // Monta o objeto PICOT
    const pico = {
      question_en:   document.getElementById("question").value.trim(),
      population:    document.getElementById("population").value.trim(),
      intervention:  document.getElementById("intervention").value.trim(),
      comparison:    document.getElementById("comparison").value.trim(),
      outcome:       document.getElementById("outcome").value.trim(),
      time:          document.getElementById("time").value.trim(),
    };
    // Bases selecionadas
    const bases = Array.from(
      document.querySelectorAll(".database-checkbox:checked")
    ).map(x => x.value);
    // Filtros por base
    const filters = {};
    bases.forEach(b => {
      filters[b] = Array.from(
        document.querySelectorAll(`input[name="filter_${b}"]:checked`)
      ).map(x => x.value);
    });
    // Ano
    const year_range = document.getElementById("year_range").value.trim();

    fetch("/results", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ pico, bases, filters, operator: "AND", year_range })
    })
    .then(res => {
      if (!res.ok) throw new Error("Search failed");
      return res.json();
    })
    .then(data => {
      // guarda e redireciona para a página de resultados
      localStorage.setItem("search_results", JSON.stringify(data));
      window.location.href = "/results";
    })
    .catch(e => {
      alert("Error fetching results: " + e.message);
    });
  }
</script>
